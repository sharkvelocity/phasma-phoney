<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phasma‚ÄëPhoney</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: url('./House.png') no-repeat center center fixed;
      background-size: cover;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    #title-img {
      margin-top: 40px;
      max-width: 80%;
      height: auto;
      filter: drop-shadow(0 0 10px cyan);
    }

    button {
      background: #222;
      color: white;
      border: 1px solid #666;
      padding: 10px;
      margin: 5px;
      cursor: pointer;
    }

    .hidden { display: none; }
    #start-btn { font-size: 16px; margin-top: 20px; }

    #game-screen {
      display: flex;
      width: 100vw;
      height: 100vh;
      justify-content: space-between;
      padding: 10px;
    }

    #left-panel, #right-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
      height: 100%;
    }

    #center-panel {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      overflow-y: auto;
    }

    #narrator-box {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      width: 90%;
      background: #111;
      padding: 10px;
      border: 1px solid #444;
    }

    #system-text, #narrator-thought {
      flex: 1;
      background: #222;
      padding: 8px;
      border: 1px solid #333;
      min-height: 60px;
    }

    #main-readout {
      background: #111;
      padding: 10px;
      margin: 5px;
      border: 1px solid #444;
      width: 90%;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    #hud-status {
      background: #111;
      padding: 10px;
      margin: 5px;
      border: 1px solid #444;
      width: 90%;
    }

    .orb {
      position: absolute;
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      box-shadow: 0 0 8px 4px rgba(255, 255, 255, 0.15);
      opacity: 0;
      animation-name: drift, fadeGlow;
      animation-timing-function: ease-in-out;
      animation-iteration-count: 1;
      pointer-events: none;
    }

    @keyframes drift {
      from { transform: translate(0, 0); }
      to { transform: translate(var(--dx), var(--dy)); }
    }

    @keyframes fadeGlow {
      0% { opacity: 0; }
      30% { opacity: 0.5; }
      60% { opacity: 0.8; }
      100% { opacity: 0.2; }
    }
  </style>
</head>

<body>
  <h1><img src="./Title.png" alt="Phasma-Phoney Title" id="title-img"></h1>
  <button id="start-btn">Start Investigation</button>

  <div id="loadout-screen" class="hidden">
    <h2>Select Your Loadout</h2>
    <div id="loadout-options"></div>
    <button id="confirm-loadout">Confirm</button>
    <button id="back-btn">Back</button>
  </div>

  <div id="game-screen" class="hidden">
    <div id="left-panel">
      <button id="journal-btn">Journal</button>
      <div id="option-buttons"></div>
    </div>

    <div id="center-panel">
      <div id="narrator-box">
        <div id="system-text"></div>
        <div id="narrator-thought"></div>
      </div>

      <div id="main-readout">welcome...</div>
      <div id="hud-status"></div>
    </div>

    <div id="right-panel">
      <div id="minimap"></div>
      <h3>Evidence Checklist</h3>
      <div id="evidence-checklist"></div>
      <ul id="possible-ghosts"></ul>
    </div>
  </div>

  <div id="journal-screen" class="hidden">
    <h1>Investigation Journal</h1>
    <textarea id="journal-entry" rows="8" cols="40"></textarea><br/>
    <button id="save-journal">Save</button>
    <button id="close-journal">Close</button>
  </div>
  <!-- Logic Scripts -->
<script>
let sanity = 100, xp = 0, turn = 1;
let cursedItemsUsed = 0, ghostActivityLevel = 0;
let lastAction = 'idle', ghost = null;
let isVanAccess = false, selectedLoadout = [];
let journalNotes = '', currentRoom = 'Foyer';

const inventory = {};
const alwaysWithYou = ['Lighter'];
const roomItems = {};
const vanInventory = {
  'EMF Reader': 1, 'Spirit Box': 1, 'Ghost Writing Book': 1,
  'Candle': 4, 'Smudge Stick': 4, 'Salt': 3, 'UV Light': 1,
  'Thermometer': 1, 'Camera': 1, 'Parabolic Mic': 1, 'Crucifix': 1,
  'Proximity Sensor': 1
};
const allItems = Object.keys(vanInventory);
const consumables = ['Smudge Stick', 'Candle', 'Salt'];

const roomMap = {
  'Foyer': { North: 'Living Room', East: 'Garage', South: 'Basement' },
  'Living Room': { South: 'Foyer', East: 'Kitchen', West: 'Dining Room' },
  'Kitchen': { West: 'Living Room' },
  'Dining Room': { East: 'Living Room' },
  'Bathroom': { North: 'Bedroom' },
  'Bedroom': { South: 'Bathroom' },
  'Garage': { West: 'Foyer' },
  'Basement': { North: 'Foyer' }
};

function getCurrentRoom() { return currentRoom; }
function movePlayer(dir) {
  const dest = roomMap[currentRoom]?.[dir];
  if (!dest) return `‚ùå Can't go ${dir}.`;
  currentRoom = dest;
  adjustSanity(-2);
  return `üö™ You move ${dir} into the ${dest}.`;
}

function getInventory() {
  return Object.keys(inventory).concat(alwaysWithYou);
}
function addItemToInventory(item) {
  const total = Object.values(inventory).reduce((a, b) => a + b, 0);
  if (total >= 3) return displayNarratorText('‚ùå You can only carry 3 items.');
  inventory[item] = 1;
  updateHUD();
}
function dropItem(item) {
  if (!inventory[item]) return `‚ùå You don‚Äôt have a ${item} to drop.`;
  if (!roomItems[currentRoom]) roomItems[currentRoom] = [];
  roomItems[currentRoom].push(item);
  delete inventory[item];
  updateHUD();
  return `üì¶ You placed the ${item} in the ${currentRoom}.`;
}
function pickUpItem(item) {
  if (!roomItems[currentRoom] || !roomItems[currentRoom].includes(item)) return `‚ùå No ${item} found here.`;
  const total = Object.values(inventory).reduce((a, b) => a + b, 0);
  if (total >= 3) return `‚ùå Your hands are full.`;
  inventory[item] = 1;
  roomItems[currentRoom] = roomItems[currentRoom].filter(i => i !== item);
  updateHUD();
  return `üéí You picked up the ${item}.`;
}

function showRoomItems() {
  const items = roomItems[currentRoom] || [];
  return items.length ? `üóÇÔ∏è Items here: ${items.join(', ')}` : 'üì≠ The room is empty.';
}

function useItem(item, room, ghostType) {
  if (!inventory[item]) return `‚ùå You don‚Äôt have a ${item}.`;
  let result = `üß™ You used the ${item} in the ${room}.`;

  if (['Spirit', 'Demon', 'Yurei', 'Succubus'].includes(ghostType) && item === 'Smudge Stick') {
    result += `\nüåÄ The ${ghostType} becomes angry!`;
  }

  const evidence = evidenceToolMap[item];
  if (evidence) {
    const success = Math.random() < 0.6;
    if (success) {
      result += `\nüîç You detect something...`;
      result += `\n${discoverEvidence(evidence)}`;
      lastAction = 'evidence';
    } else {
      result += `\nüïØÔ∏è It‚Äôs quiet. Maybe try again later.`;
      lastAction = 'idle';
    }
  }

  if (consumables.includes(item)) {
    delete inventory[item];
    updateHUD();
  }
  return result;
}

function discoverEvidence(ev) {
  const check = [...document.querySelectorAll('#evidence-checklist input')];
  const box = check.find(c => c.value === ev);
  if (box && !box.checked) {
    box.checked = true;
    box.dispatchEvent(new Event('change'));
    return `Evidence marked: ${ev}`;
  }
  return `Nothing new was found.`;
}

function updateHUD() {
  document.getElementById('hud-status').innerText =
    `Turn: ${turn} | Sanity: ${sanity}% | XP: ${xp} | Inventory: ${getInventory().join(', ') || 'none'}`;
}

function adjustSanity(change) {
  sanity = Math.max(0, Math.min(100, sanity + change));
}

function tickTurn() {
  turn++;
  updateHUD();
  displayNarratorText(performGhostAction());
  narrateAmbience();
}

function triggerHunt() {
  lastAction = 'hunt';
  ghostActivityLevel = 10;
  adjustSanity(-30);
  displayNarratorText("üíÄ The ghost begins a hunt!");
}

// GHOST SYSTEM
const ghostTypes = [
  'Spirit', 'Wraith', 'Phantom', 'Poltergeist', 'Banshee',
  'Jinn', 'Mare', 'Revenant', 'Shade', 'Demon',
  'Yurei', 'Oni', 'Hantu', 'Goryo', 'Myling',
  'Onryo', 'The Twins', 'Raiju', 'Obake', 'The Mimic',
  'Moroi', 'Deogen', 'Thaye', 'Succubus'
];

function getRandomGhost() {
  const type = ghostTypes[Math.floor(Math.random() * ghostTypes.length)];
  return {
    type,
    behavior: room => {
      const base = [
        `You feel watched in the ${room}.`,
        `A chill runs through the ${room}.`,
        `The lights flicker in the ${room}.`
      ];
      const bonus = {
        Poltergeist: [`Objects clatter violently in the ${room}.`],
        Banshee: [`A piercing wail echoes through the ${room}.`],
        Succubus: [`A sultry whisper beckons in the ${room}.`]
      };
      return [...base, ...(bonus[type] || [])][Math.floor(Math.random() * base.length)];
    }
  };
}

function initializeGhost(g) { ghost = g; }
function getCurrentGhost() { return ghost; }
function performBehavior(room) {
  return ghost?.behavior(room) || "Nothing happens.";
}
function performGhostAction() {
  if (Math.random() < 0.3) {
    ghostActivityLevel += 1;
    return `üîä You hear something shifting...`;
  }
  return `Nothing yet. Stay vigilant.`;
}

// EVIDENCE
const allEvidence = [
  'EMF 5', 'Spirit Box', 'Fingerprints', 'Ghost Orbs',
  'Ghost Writing', 'Freezing Temps', 'D.O.T.S'
];

const ghostEvidenceMap = {
  Spirit: ['EMF 5', 'Spirit Box', 'Ghost Writing'],
  Wraith: ['EMF 5', 'Spirit Box', 'D.O.T.S'],
  Phantom: ['Spirit Box', 'Fingerprints', 'D.O.T.S'],
  Poltergeist: ['Spirit Box', 'Fingerprints', 'Ghost Writing'],
  Banshee: ['Fingerprints', 'Ghost Orbs', 'D.O.T.S'],
  Jinn: ['EMF 5', 'Fingerprints', 'Freezing Temps'],
  Mare: ['Spirit Box', 'Ghost Orbs', 'Ghost Writing'],
  Revenant: ['Ghost Orbs', 'Ghost Writing', 'Freezing Temps'],
  Shade: ['EMF 5', 'Ghost Writing', 'Freezing Temps'],
  Demon: ['Fingerprints', 'Ghost Writing', 'Freezing Temps'],
  Yurei: ['Ghost Orbs', 'Freezing Temps', 'D.O.T.S'],
  Oni: ['EMF 5', 'Freezing Temps', 'D.O.T.S'],
  Hantu: ['Fingerprints', 'Ghost Orbs', 'Freezing Temps'],
  Goryo: ['EMF 5', 'Fingerprints', 'D.O.T.S'],
  Myling: ['EMF 5', 'Fingerprints', 'Ghost Writing'],
  Onryo: ['Spirit Box', 'Ghost Orbs', 'Freezing Temps'],
  'The Twins': ['EMF 5', 'Spirit Box', 'Freezing Temps'],
  Raiju: ['EMF 5', 'Ghost Orbs', 'D.O.T.S'],
  Obake: ['EMF 5', 'Fingerprints', 'Ghost Orbs'],
  'The Mimic': ['Spirit Box', 'Fingerprints', 'Freezing Temps'],
  Moroi: ['Spirit Box', 'Ghost Writing', 'Freezing Temps'],
  Deogen: ['Spirit Box', 'Ghost Writing', 'D.O.T.S'],
  Thaye: ['Ghost Orbs', 'Ghost Writing', 'D.O.T.S'],
  Succubus: ['Spirit Box', 'Ghost Writing', 'EMF 5']
};

const evidenceToolMap = {
  'EMF Reader': 'EMF 5',
  'Spirit Box': 'Spirit Box',
  'UV Light': 'Fingerprints',
  'Thermometer': 'Freezing Temps',
  'Camera': 'Ghost Orbs',
  'Ghost Writing Book': 'Ghost Writing',
  'Parabolic Mic': 'Whispers',
  'Salt': 'Footprints'
};

// CONTINUES: renderEvidenceChecklist, Journal, Guess Menu, Weather, Tarot, Ambient Narration, and DOM setup‚Ä¶
  // Evidence rendering
function renderEvidenceChecklist() {
  const container = document.getElementById('evidence-checklist');
  container.innerHTML = '';
  allEvidence.forEach(ev => {
    const label = document.createElement('label');
    label.style.display = 'block';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = ev;
    checkbox.onchange = updatePossibleGhosts;

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(' ' + ev));
    container.appendChild(label);
  });
}

function updatePossibleGhosts() {
  const selected = Array.from(document.querySelectorAll('#evidence-checklist input:checked')).map(cb => cb.value);
  const list = document.getElementById('possible-ghosts');
  list.innerHTML = '';

  if (selected.length === 0) {
    list.innerHTML = '<li>All ghosts are possible</li>';
    return;
  }

  const matches = Object.entries(ghostEvidenceMap).filter(([ghost, evidence]) =>
    selected.every(sel => evidence.includes(sel))
  ).map(([ghost]) => ghost);

  list.innerHTML = matches.length
    ? matches.map(g => `<li>${g}</li>`).join('')
    : '<li>No ghosts match this combination</li>';
}

// Journal
function initializeJournal() {
  document.getElementById('journal-entry').value = journalNotes;
  renderEvidenceChecklist();
}
function updateNotes(txt) {
  journalNotes = txt;
  displayNarratorText("üìì Notes saved.");
}

// Loadout
function showLoadoutMenu() {
  const container = document.getElementById('loadout-options');
  container.innerHTML = '';
  selectedLoadout = [];

  allItems.forEach(item => {
    const btn = document.createElement('button');
    btn.innerText = item;
    btn.onclick = () => {
      const idx = selectedLoadout.indexOf(item);
      if (idx >= 0) {
        selectedLoadout.splice(idx, 1);
        btn.style.background = '';
      } else {
        if (selectedLoadout.length >= 3) {
          alert("üéí You can only carry 3 items.");
          return;
        }
        selectedLoadout.push(item);
        btn.style.background = 'darkgreen';
      }
    };
    container.appendChild(btn);
  });
}

// Guessing
function guessMenu() {
  const container = document.getElementById('option-buttons');
  container.innerHTML = '';
  ghostTypes.forEach(ghost => {
    const btn = document.createElement('button');
    btn.innerText = ghost;
    btn.onclick = () => {
      const correct = ghost === getCurrentGhost().type;
      const message = correct
        ? `‚úÖ Correct! The ghost was a ${ghost}. You've survived and earned XP!`
        : `‚ùå Wrong. It was actually a ${getCurrentGhost().type}. Better luck next time.`;
      if (correct) xp += 50;
      displayNarratorText(message);
      container.innerHTML = '';
    };
    container.appendChild(btn);
  });

  const back = document.createElement('button');
  back.innerText = 'Back';
  back.onclick = renderOptions;
  container.appendChild(back);
}

// Tarot
const tarotCards = [
  'üÉè The Fool ‚Äì Nothing happens.',
  'ü™¶ The Hanged Man ‚Äì You feel your sanity drain rapidly.',
  '‚òÄÔ∏è The Sun ‚Äì Sanity fully restored!',
  'üåë The Moon ‚Äì Sanity drops to 0!',
  'üßô The Hermit ‚Äì The ghost is temporarily trapped.',
  'üé° The Wheel of Fortune ‚Äì Sanity shifts unpredictably.',
  'üíÄ Death ‚Äì A hunt begins instantly!',
  'üëπ The Devil ‚Äì The ghost manifests nearby.',
  'üóº The Tower ‚Äì A crash rings out. The ghost moves to your room.',
  'üëº The High Priestess ‚Äì You sense a protective spirit.'
];

function useCursedItem(name) {
  cursedItemsUsed++;
  adjustSanity(-20);
  let result = `üîÆ You use the ${name}. Reality ripples...`;
  if (name.toLowerCase().includes('tarot')) result += '\n' + drawTarotCard();
  lastAction = 'cursed item';
  return result;
}

function drawTarotCard() {
  const card = tarotCards[Math.floor(Math.random() * tarotCards.length)];
  if (card.includes('sanity drain')) adjustSanity(-30);
  if (card.includes('fully restored')) adjustSanity(100 - sanity);
  if (card.includes('drops to 0')) sanity = 0;
  if (card.includes('hunt')) triggerHunt();
  if (card.includes('manifest')) ghostActivityLevel = 7;
  if (card.includes('moves to your room')) ghostActivityLevel = 8;
  return `üÉè Tarot card drawn: ${card}`;
}

// Ambient narration (simplified)
function narrateAmbience() {
  const room = getCurrentRoom();
  const lines = {
    'Foyer': ["Something waits beyond the welcome mat."],
    'Basement': ["You hear something breathing behind the boiler."],
    'Living Room': ["Couch cushions sag, like they expect company."],
    'Bathroom': ["Your reflection wavers slightly..."],
    'Garage': ["Tools hang neatly. Some have moved."]
  };
  if (Math.random() < 0.4) {
    const line = (lines[room] || ["You feel uneasy..."])[0];
    displayNarratorText(`üß† ${line}`);
  }
}

// Orbs
function spawnOrbs(count = 4) {
  for (let i = 0; i < count; i++) {
    const orb = document.createElement('div');
    orb.className = 'orb';
    orb.style.left = Math.random() * 100 + 'vw';
    orb.style.top = Math.random() * 100 + 'vh';
    orb.style.setProperty('--dx', (Math.random() - 0.5) * 150 + 'px');
    orb.style.setProperty('--dy', (Math.random() - 0.5) * 150 + 'px');
    const duration = 8 + Math.random() * 10;
    orb.style.animationDuration = `${duration}s, ${duration}s`;
    orb.style.animationDelay = `0s, ${Math.random() * 3}s`;
    document.body.appendChild(orb);
    setTimeout(() => {
      orb.style.transition = 'opacity 2s ease-out';
      orb.style.opacity = 0;
      setTimeout(() => orb.remove(), 3000);
    }, duration * 1000);
  }
}
setInterval(() => {
  if (document.hasFocus()) spawnOrbs(Math.floor(Math.random() * 2) + 1);
}, 5000);

// UI Options
function renderOptions() {
  const container = document.getElementById('option-buttons');
  container.innerHTML = '';

  const btn = (label, handler) => {
    const b = document.createElement('button');
    b.innerText = label;
    b.onclick = handler;
    container.appendChild(b);
  };

  btn('Move', () => {
    container.innerHTML = '';
    ['North', 'East', 'South', 'West'].forEach(dir => {
      const d = document.createElement('button');
      d.innerText = `Go ${dir}`;
      d.onclick = () => {
        displayNarratorText(movePlayer(dir));
        tickTurn();
        renderMinimap();
        renderOptions();
      };
      container.appendChild(d);
    });
    const back = document.createElement('button');
    back.innerText = 'Back';
    back.onclick = renderOptions;
    container.appendChild(back);
  });

  btn('Investigate', () => {
    displayNarratorText(performBehavior(getCurrentRoom()));
    adjustSanity(-5);
    tickTurn();
    renderMinimap();
  });

  btn('Use Item', () => {
    const items = getInventory();
    container.innerHTML = '';
    if (!items.length) {
      displayNarratorText("üß≥ You have no items.");
      renderOptions();
      return;
    }
    items.forEach(item => {
      const i = document.createElement('button');
      i.innerText = `Use ${item}`;
      i.onclick = () => {
        displayNarratorText(useItem(item, getCurrentRoom(), getCurrentGhost().type));
        tickTurn();
        renderMinimap();
        renderOptions();
      };
      container.appendChild(i);
    });
    const back = document.createElement('button');
    back.innerText = 'Back';
    back.onclick = renderOptions;
    container.appendChild(back);
  });

  btn('Drop Item', () => {
    const items = getInventory().filter(i => !alwaysWithYou.includes(i));
    container.innerHTML = '';
    if (!items.length) {
      displayNarratorText("üì¶ Nothing to drop.");
      renderOptions();
      return;
    }
    items.forEach(item => {
      const b = document.createElement('button');
      b.innerText = `Drop ${item}`;
      b.onclick = () => {
        displayNarratorText(dropItem(item));
        renderOptions();
      };
      container.appendChild(b);
    });
    const back = document.createElement('button');
    back.innerText = 'Back';
    back.onclick = renderOptions;
    container.appendChild(back);
  });

  btn('Pick Up Item', () => {
    const items = roomItems[getCurrentRoom()] || [];
    container.innerHTML = '';
    if (!items.length) {
      displayNarratorText("üì≠ Nothing to pick up.");
      renderOptions();
      return;
    }
    items.forEach(item => {
      const b = document.createElement('button');
      b.innerText = `Pick Up ${item}`;
      b.onclick = () => {
        displayNarratorText(pickUpItem(item));
        renderOptions();
      };
      container.appendChild(b);
    });
    const back = document.createElement('button');
    back.innerText = 'Back';
    back.onclick = renderOptions;
    container.appendChild(back);
  });

  btn('Guess Ghost', guessMenu);

  btn('Return to Van', () => {
    isVanAccess = true;
    showLoadoutMenu();
    document.getElementById('loadout-screen').classList.remove('hidden');
  });

  renderMinimap();
}

// Game Start
function startGame() {
  resetStats();
  ghost = getRandomGhost();
  initializeGhost(ghost);
  initializeJournal();
  updateHUD();
  displayNarratorText("So it begins...");
  renderOptions();
}

// DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  const startBtn = document.getElementById('start-btn');
  const gameScreen = document.getElementById('game-screen');
  const loadoutScreen = document.getElementById('loadout-screen');
  const confirmBtn = document.getElementById('confirm-loadout');
  const backBtn = document.getElementById('back-btn');
  const journalBtn = document.getElementById('journal-btn');
  const saveJournalBtn = document.getElementById('save-journal');
  const closeJournalBtn = document.getElementById('close-journal');
  const journalScreen = document.getElementById('journal-screen');

  startBtn.onclick = () => {
    const wantsLoadout = confirm("Do you want to select a loadout?");
    if (wantsLoadout) {
      showLoadoutMenu();
      loadoutScreen.classList.remove('hidden');
      startBtn.style.display = 'none';
    } else {
      gameScreen.classList.remove('hidden');
      startBtn.style.display = 'none';
      startGame();
    }
  };

  confirmBtn.onclick = () => {
    loadoutScreen.classList.add('hidden');
    if (isVanAccess) {
      isVanAccess = false;
      renderOptions();
      return;
    }
    selectedLoadout.forEach(item => inventory[item] = 1);
    gameScreen.classList.remove('hidden');
    startGame();
  };

  backBtn.onclick = () => {
    loadoutScreen.classList.add('hidden');
    if (isVanAccess) {
      isVanAccess = false;
      renderOptions();
    } else {
      startBtn.style.display = 'inline-block';
    }
  };

  journalBtn.onclick = () => {
    initializeJournal();
    journalScreen.classList.remove('hidden');
  };

  saveJournalBtn.onclick = () => {
    const text = document.getElementById('journal-entry').value;
    updateNotes(text);
    journalScreen.classList.add('hidden');
  };

  closeJournalBtn.onclick = () => {
    journalScreen.classList.add('hidden');
  };
});
</script>
</body>
</html>
