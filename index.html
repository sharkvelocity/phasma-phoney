<script>
let isOn = false, currentVision = 'night';
let zoomLevel = 1, zoomIndex = 0;
const zoomSteps = [1, 1.5, 2, 2.5, 3];
let score = 0, orbsCaptured = 0, timeLeft = 60, timerStarted = false;
let gameInterval, lastTap = 0;
let ticking = false, heartbeat = false;

const lens = document.getElementById('lens');
const pointer = document.getElementById('lens-pointer');
const zoomHud = document.getElementById('zoom-hud');
const scoreHud = document.getElementById('score-hud');
const tickSound = document.getElementById('tick-sound');
const heartbeatSound = document.getElementById('heartbeat-sound');

const flipMinTen = document.getElementById('min-ten');
const flipMinOne = document.getElementById('min-one');
const flipSecTen = document.getElementById('sec-ten');
const flipSecOne = document.getElementById('sec-one');

function togglePower() {
  isOn = !isOn;
  lens.style.display = isOn ? 'block' : 'none';
  pointer.style.display = isOn ? 'block' : 'none';
  zoomHud.style.display = isOn ? 'block' : 'none';
  scoreHud.style.display = isOn ? 'block' : 'none';
  if (isOn && !timerStarted) startTimer();
}

function toggleVision() {
  if (!isOn) return;
  currentVision = (currentVision === 'night') ? 'heat' : 'night';
  lens.classList.toggle('vision-night', currentVision === 'night');
  lens.classList.toggle('vision-heat', currentVision === 'heat');
  updateOrbsVisibility();
}

function updateZoomVisual() {
  zoomHud.textContent = `Zoom: ${zoomLevel.toFixed(1)}x`;
  const lensSize = 200 + (zoomLevel - 1) * 100;
  lens.style.width = `${lensSize}px`;
  lens.style.height = `${lensSize}px`;
}

function moveLens(x, y) {
  if (!isOn) return;
  const lensSize = parseFloat(lens.style.width || "200px");
  const half = lensSize / 2;
  lens.style.transform = `translate(${x - half}px, ${y - half}px)`;
  pointer.style.transform = `translate(${x - 10}px, ${y - 10}px)`;
}

function tryCapture(x, y) {
  if (!isOn) return;
  const lensRect = lens.getBoundingClientRect();
  const centerX = lensRect.left + lensRect.width / 2;
  const centerY = lensRect.top + lensRect.height / 2;

  document.querySelectorAll('.orb').forEach(orb => {
    const rect = orb.getBoundingClientRect();
    const dx = (rect.left + rect.width/2) - centerX;
    const dy = (rect.top + rect.height/2) - centerY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const maxDist = lensRect.width / 2;
    const proximity = 1 - Math.min(dist / maxDist, 1);

    const isSpecial = orb.classList.contains('special-orb');
    const valid = (isSpecial && currentVision === 'heat') || (!isSpecial && currentVision === 'night');

    if (dist < maxDist && valid) {
      let orbScore = isSpecial ? 1000 : Math.floor(proximity * 100 * zoomLevel);
      let bonusTime = isSpecial ? 50 : Math.floor(orbScore / 20);
      score += orbScore;
      timeLeft += bonusTime;
      orbsCaptured++;
      updateScore();
      orb.remove();

      // Stop ticking if time boosted above 20
      if (timeLeft > 20) stopSounds();

      if (score >= 5000) endGame(true);
    }
  });
}

function updateScore() {
  scoreHud.textContent = `Score: ${score}`;
}

function startTimer() {
  timerStarted = true;
  updateFlipClock();
  gameInterval = setInterval(() => {
    timeLeft--;
    updateFlipClock();

    if (timeLeft <= 0) endGame(false);
    if (timeLeft <= 10 && !heartbeat) {
      stopSounds();
      heartbeat = true;
      heartbeatSound.loop = true;
      heartbeatSound.play();
    } else if (timeLeft <= 20 && !ticking) {
      tickSound.loop = true;
      tickSound.play();
      ticking = true;
    }
  }, 1000);
}

function stopSounds() {
  tickSound.pause();
  heartbeatSound.pause();
  ticking = false;
  heartbeat = false;
}

function updateFlipClock() {
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  flipMinTen.textContent = Math.floor(minutes / 10);
  flipMinOne.textContent = minutes % 10;
  flipSecTen.textContent = Math.floor(seconds / 10);
  flipSecOne.textContent = seconds % 10;
}

function endGame(won = false) {
  clearInterval(gameInterval);
  stopSounds();
  document.getElementById("game-over").style.display = "flex";
  document.getElementById("end-title").textContent = won ? "ðŸŽ‰ You Win!" : "â±ï¸ Time's up!";
  document.getElementById("final-score").textContent = `Final Score: ${score}`;
  document.getElementById("orbs-counted").textContent = `Orbs Captured: ${orbsCaptured}`;
  document.getElementById("orbs").innerHTML = "";
}

function spawnOrbs() {
  const container = document.getElementById('orbs');
  container.innerHTML = "";
  const count = Math.floor(Math.random() * 2) + 2;

  for (let i = 0; i < count; i++) {
    const orb = document.createElement('div');
    const isSpecial = Math.random() < 0.1;
    orb.className = `orb ${isSpecial ? 'special-orb' : 'regular-orb'}`;
    orb.style.left = Math.random() * 90 + 'vw';
    orb.style.top = Math.random() * 80 + 'vh';
    container.appendChild(orb);
  }
  updateOrbsVisibility();
}

function updateOrbsVisibility() {
  document.querySelectorAll('.orb').forEach(orb => {
    const isSpecial = orb.classList.contains('special-orb');
    const visible = isSpecial ? currentVision === 'heat' : currentVision === 'night';
    orb.style.opacity = (isOn && visible) ? 1 : 0;
  });
}

function cycleZoom() {
  if (!isOn) return;
  zoomIndex = (zoomIndex + 1) % zoomSteps.length;
  zoomLevel = zoomSteps[zoomIndex];
  updateZoomVisual();
}

document.addEventListener('mousemove', e => moveLens(e.clientX, e.clientY));
document.addEventListener('click', e => tryCapture(e.clientX, e.clientY));
document.addEventListener('dblclick', () => isOn && cycleZoom());

document.addEventListener('touchstart', e => {
  const now = Date.now();
  if (now - lastTap < 300) {
    cycleZoom();
    lastTap = 0;
  } else {
    tryCapture(e.touches[0].clientX, e.touches[0].clientY);
    lastTap = now;
  }
});

setInterval(spawnOrbs, 8000);
spawnOrbs();
</script>
</body>
</html>
