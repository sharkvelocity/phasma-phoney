<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ghost Orb Capture 360Â°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/photo-sphere-viewer@5/dist/photo-sphere-viewer.css" />
  <script src="https://unpkg.com/three/build/three.min.js"></script>
  <script src="https://unpkg.com/photo-sphere-viewer@5/dist/photo-sphere-viewer.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: black;
      font-family: monospace;
      cursor: none;
    }
    #viewer {
      width: 100vw;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 0;
    }
    canvas.orb-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }
    .hud {
      position: fixed;
      z-index: 10;
      color: lime;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid lime;
      padding: 6px 12px;
      font-size: 14px;
    }
    #score-hud { bottom: 10px; left: 10px; }
    #zoom-hud { bottom: 10px; right: 10px; }
    #feedback-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      padding: 20px 40px;
      background: rgba(0,0,0,0.8);
      border: 2px solid lime;
      color: lime;
      font-size: 2em;
      font-family: monospace;
      z-index: 99;
      display: none;
      pointer-events: none;
    }
    #lens {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      backdrop-filter: brightness(1.4) contrast(1.4);
      mix-blend-mode: screen;
      z-index: 5;
    }
    .vision-night { filter: hue-rotate(90deg) grayscale(0.1); }
    .vision-heat { filter: hue-rotate(270deg) saturate(2); }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 11;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .btn {
      background: rgba(0,0,0,0.7);
      color: lime;
      border: 1px solid lime;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="viewer"></div>
  <canvas id="orb-canvas" class="orb-layer"></canvas>
  <div id="lens" class="vision-night"></div>
  <div id="controls">
    <button class="btn" onclick="startGame()">Start</button>
    <button class="btn" onclick="toggleVision()">Toggle Vision</button>
  </div>
  <div id="score-hud" class="hud">Score: 0</div>
  <div id="zoom-hud" class="hud">Zoom: 1x</div>
  <div id="feedback-popup"></div>
  <audio id="tick-sound" preload="auto"><source src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA..." type="audio/mp3" /></audio>
  <audio id="heartbeat-sound" preload="auto"><source src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA..." type="audio/mp3" /></audio>
  <script>
    let score = 0, multiplier = 1, timeLeft = 60, timerStarted = false, ticking = false, heartbeat = false;
    let viewer, orbCanvas, orbCtx, orbs = [];

    document.addEventListener('DOMContentLoaded', () => {
      orbCanvas = document.getElementById('orb-canvas');
      orbCanvas.width = window.innerWidth;
      orbCanvas.height = window.innerHeight;
      orbCtx = orbCanvas.getContext('2d');

      viewer = new PhotoSphereViewer.Viewer({
        container: document.getElementById('viewer'),
        panorama: 'sky.webp',
        navbar: false,
        mousewheel: false,
        touchmoveTwoFingers: true,
        defaultYaw: 'center'
      });

      viewer.on('position-updated', renderOrbs);
    });

    function startGame() {
      if (timerStarted) return;
      timerStarted = true;
      updateScore();
      setInterval(spawnOrb, 3000);
      setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          showPopup(`Final Score: ${score}`, 'cyan');
          stopSounds();
        }
        if (timeLeft <= 10 && !heartbeat) {
          stopSounds();
          heartbeat = true;
          document.getElementById('heartbeat-sound').loop = true;
          document.getElementById('heartbeat-sound').play();
        } else if (timeLeft <= 20 && !ticking) {
          document.getElementById('tick-sound').loop = true;
          document.getElementById('tick-sound').play();
          ticking = true;
        }
      }, 1000);
    }

    function spawnOrb() {
      const isSpecial = Math.random() < 0.1;
      const yaw = Math.random() * 360 - 180;
      const pitch = Math.random() * 90 - 45;
      orbs.push({ yaw, pitch, isSpecial, age: 0 });
    }

    function renderOrbs() {
      orbCtx.clearRect(0, 0, orbCanvas.width, orbCanvas.height);
      const position = viewer.getPosition();
      const size = orbCanvas.getBoundingClientRect();

      orbs.forEach((orb, i) => {
        orb.age++;
        if (orb.age > 240) {
          orbs.splice(i, 1);
          multiplier = 1;
          showPopup('Missed', 'red');
          return;
        }

        const coords = viewer.dataHelper.sphericalCoordsToViewerCoords({ yaw: orb.yaw, pitch: orb.pitch });
        if (!coords) return;

        orbCtx.beginPath();
        orbCtx.arc(coords.x, coords.y, 10, 0, Math.PI * 2);
        orbCtx.fillStyle = orb.isSpecial ? 'rgba(0,100,255,0.6)' : 'rgba(255,255,255,0.6)';
        orbCtx.fill();
      });
    }

    orbCanvas.addEventListener('click', e => {
      const rect = orbCanvas.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;

      orbs = orbs.filter(orb => {
        const coords = viewer.dataHelper.sphericalCoordsToViewerCoords({ yaw: orb.yaw, pitch: orb.pitch });
        if (!coords) return true;
        const dx = coords.x - cx;
        const dy = coords.y - cy;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 20) {
          const basePoints = orb.isSpecial ? 1000 : 100;
          score += basePoints * multiplier;
          multiplier++;
          updateScore();
          showPopup(`+${basePoints * multiplier} x${multiplier - 1}`);
          return false;
        }
        return true;
      });
    });

    function toggleVision() {
      const lens = document.getElementById('lens');
      lens.classList.toggle('vision-night');
      lens.classList.toggle('vision-heat');
    }

    function updateScore() {
      document.getElementById('score-hud').textContent = `Score: ${score}`;
    }

    function showPopup(text, color = 'lime') {
      const popup = document.getElementById('feedback-popup');
      popup.style.color = color;
      popup.textContent = text;
      popup.style.display = 'block';
      setTimeout(() => popup.style.display = 'none', 1000);
    }

    function stopSounds() {
      document.getElementById('tick-sound').pause();
      document.getElementById('heartbeat-sound').pause();
      ticking = false;
      heartbeat = false;
    }
  </script>
</body>
</html>
