<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PhasmaPhoney</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
      height: 100%;
      font-family: monospace;
    }

    button {
      background: #000;
      color: #0ff;
      border: 1px solid #0ff;
      padding: 8px 14px;
      margin: 4px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #0ff;
      color: #000;
    }

    #orb-canvas, #background-logo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -2;
    }

    #background-logo {
      background: url('Title.png') center/contain no-repeat;
      opacity: .1;
      z-index: -3;
    }

    .scene-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: -1;
    }

    .layer {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .background { z-index: 1; }
    .lightning {
      z-index: 2;
      background: white;
      opacity: 0;
      transition: opacity 0.15s ease-in-out;
    }
    .foreground { z-index: 3; }

    #flash-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 999;
    }

    @media (max-width: 768px) {
      #status-bar, #evidence-panel, #game-ui {
        font-size: 0.8em;
        padding: 6px;
      }
      #game-ui {
        margin: 80px 10px 20px 10px;
      }
      #evidence-panel {
        width: 90%;
        right: 5%;
      }
      .scene-container img.layer {
        object-fit: contain;
      }
    }
  </style>
</head>
<body>
  <!-- SCENE BACKGROUND AND LAYERS -->
  <div class="scene-container">
    <img src="https://www.dropbox.com/scl/fi/b1r0ez74v60dnpuqxdzpj/background.png?rlkey=fbf34d7fobq08dihq0urnex3v&dl=1" class="layer background" />
    <div class="layer lightning"></div>
    <img src="https://www.dropbox.com/scl/fi/l6i8ln2sjxg7r7xd5qei0/foreground.png?rlkey=mcxmo7gzk8hwu8o9k4oi8hdk0&dl=1" class="layer foreground" />
  </div>
  <canvas id="orb-canvas"></canvas>
  <div id="background-logo"></div>
  <div id="flash-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;opacity:0;pointer-events:none;z-index:999;"></div>

  <script>
    const flash = document.querySelector(".lightning");
    function triggerFlash() {
      flash.style.opacity = "0.4";
      setTimeout(() => flash.style.opacity = "0", 150);
    }
    setInterval(() => {
      if (Math.random() > 0.6) triggerFlash();
    }, 7000);
  </script>

  <script>
    const canvas = document.getElementById("orb-canvas");
    const ctx = canvas.getContext("2d");
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;

    function createOrb() {
      return {
        x: Math.random() * width,
        y: Math.random() * height,
        vx: (Math.random() - 0.5) * 0.8,
        vy: (Math.random() - 0.5) * 0.8,
        baseRadius: Math.random() * 2 + 1,
        radius: 1,
        opacity: 0,
        fadeIn: true,
        tick: 0,
        changeInterval: Math.floor(Math.random() * 150 + 50)
      };
    }

    let orbs = Array.from({ length: 15 }, createOrb);

    function animateOrbs() {
      ctx.clearRect(0, 0, width, height);
      for (let orb of orbs) {
        orb.tick++;
        orb.radius = orb.baseRadius + Math.sin(orb.tick / 30) * 0.5;
        orb.opacity += orb.fadeIn ? 0.01 : -0.001;
        if (orb.opacity >= 0.6) { orb.opacity = 0.6; orb.fadeIn = false; }
        if (orb.opacity <= 0.01) Object.assign(orb, createOrb());
        if (orb.tick % orb.changeInterval === 0) {
          const angle = Math.random() * 2 * Math.PI;
          const speed = Math.sqrt(orb.vx ** 2 + orb.vy ** 2);
          orb.vx = orb.vx * 0.8 + Math.cos(angle) * speed * 0.2;
          orb.vy = orb.vy * 0.8 + Math.sin(angle) * speed * 0.2;
        }
        orb.x += orb.vx;
        orb.y += orb.vy;
        if (orb.x - orb.radius <= 0 || orb.x + orb.radius >= width) orb.vx *= -1;
        if (orb.y - orb.radius <= 0 || orb.y + orb.radius >= height) orb.vy *= -1;

        ctx.beginPath();
        ctx.arc(orb.x, orb.y, orb.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255,255,255,${orb.opacity})`;
        ctx.shadowColor = `rgba(255,255,255,${orb.opacity * 0.6})`;
        ctx.shadowBlur = 10 + orb.opacity * 10;
        ctx.fill();
      }

      requestAnimationFrame(animateOrbs);
    }
    animateOrbs();

    window.addEventListener("resize", () => {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    });
  </script>
  <!-- STATUS BAR (HUD) -->
  <div id="status-bar">
    <div>
      Turn: <span id="turn-counter">0</span> |
      Sanity: <span id="sanity-bar">100</span>%
    </div>
    <div id="map-display">Room: Van</div>
  </div>

  <!-- EVIDENCE PANEL -->
  <div id="evidence-panel">
    <h3 style="margin:0;">Evidence</h3>
    <div id="evidence-checklist"></div>
    <p id="remaining-ghosts" style="color:#0f0;"></p>
  </div>

  <!-- MAIN GAME UI OUTPUT -->
  <div id="game-ui"></div>

  <!-- LOADOUT SELECTION -->
  <div id="loadout-screen">
    <h2>Select Loadout (Max 3)</h2>
    <div id="item-selection" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
    <button onclick="confirmLoadout()">Confirm Loadout</button>
    <button onclick="randomLoadout()">Random Loadout</button>
  </div>

  <!-- VAN PANEL -->
  <div id="van-panel">
    <h3>Van Inventory</h3>
    <div id="van-button-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    <button onclick="closeVanPanel()">Done</button>
  </div>

  <!-- GUESS GHOST POPUP -->
  <div id="guess-popup">
    <h3>Who is the Ghost?</h3>
    <div id="guess-list" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
    <button onclick="closeGuess()">Cancel</button>
  </div>

  <!-- ITEM POPUP -->
  <div id="item-popup">
    <h3>Choose Item</h3>
    <div id="item-button-list" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    <button onclick="closeItemPopup()">Cancel</button>
  </div>

  <!-- JOURNAL -->
  <div id="journal-screen">
    <h3>Notes</h3>
    <textarea id="journal-text" placeholder="Your notes..."></textarea><br>
    <button onclick="closeJournal()">Close</button>
  </div>

  <!-- ADA COMMAND PANEL -->
  <div id="ada-modal">
    <div id="ada-log" style="height:85%; overflow-y:auto; background:#000; padding:10px;"></div>
    <div style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-top:10px;">
      <button onclick="handleCommand('start')">Start</button>
      <button onclick="handleCommand('move')">Move</button>
      <button onclick="handleCommand('map')">Map</button>
      <button onclick="handleCommand('inventory')">Inventory</button>
      <button onclick="openGuess()">Guess</button>
      <button onclick="handleCommand('van')">Visit Van</button>
      <button onclick="handleCommand('end')">End</button>
      <button onclick="openItemPopup()">Use Items</button>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>Phasma‑Phoney v1.4 — Full Gameplay</footer>
<script>
const allLoadoutItems = ["EMF", "Spirit Box", "UV", "Camera", "D.O.T.S", "Book", "Thermometer", "Smudge", "Crucifix", "Salt", "Candle"];
const evidenceTypes = ["EMF Level 5", "Spirit Box", "Fingerprints", "Ghost Writing", "Freezing Temps", "D.O.T.S", "Orbs"];

const evidenceMap = {
  spirit: ["EMF Level 5", "Spirit Box", "Ghost Writing"],
  wraith: ["EMF Level 5", "D.O.T.S", "Spirit Box"],
  poltergeist: ["Spirit Box", "Ghost Writing", "Fingerprints"],
  demon: ["Ghost Writing", "Freezing Temps", "Fingerprints"],
  succubus: ["Spirit Box", "Freezing Temps", "Orbs"]
};

const ghostProfiles = {
  spirit: { intro: "Calm presence", tools: ["emf","spirit box","book"], behavior: "You hear soft whispers...", roomHint: "Library" },
  wraith: { intro: "Avoids salt", tools: ["emf","dots","spirit box"], behavior: "The air shifts...but salt untouched.", roomHint: "Bathroom" },
  poltergeist: { intro: "Throws items", tools: ["spirit box","book","uv"], behavior: "Objects rattle violently!", roomHint: "Kitchen" },
  demon: { intro: "Aggressive early", tools: ["book","thermometer","uv"], behavior: "A low growl echoes!", roomHint: "Basement" },
  succubus: { intro: "Seductive chill", tools: ["spirit box","thermometer","camera"], behavior: "A chill passes your spine.", roomHint: "Bedroom" }
};

let game = {
  inventory: [],
  vanStock: {},
  turn: 0,
  sanity: 100,
  ghost: null,
  ghostRoom: null,
  position: [0, 0],
  roomMap: [
    ["Van", "Foyer", "Kitchen"],
    ["Basement", "Living Room", "Bathroom"],
    ["Garage", "Bedroom", "Storage"]
  ]
};

let selectedEvidence = new Set();

function log(txt) {
  const g = document.getElementById("ada-log");
  const d = document.createElement("div");
  d.innerHTML = "<strong>ADA:</strong> " + txt;
  g.appendChild(d);
  g.scrollTop = g.scrollHeight;
}

function updateMap() {
  const mapd = game.roomMap[game.position[0]][game.position[1]];
  document.getElementById("map-display").textContent = "Room: " + mapd;
}

function handleCommand(cmd) {
  const c = cmd.toLowerCase();
  game.turn++;
  document.getElementById("turn-counter").textContent = game.turn;

  if (c === "start") {
    const keys = Object.keys(ghostProfiles);
    game.ghost = keys[Math.floor(Math.random() * keys.length)];
    game.ghostRoom = ghostProfiles[game.ghost].roomHint;
    log("Ghost is in the " + game.ghostRoom);
  } else if (c === "move") {
    game.position[1] = (game.position[1] + 1) % 3;
    updateMap();
    game.sanity = Math.max(0, game.sanity - 5);
    document.getElementById("sanity-bar").textContent = game.sanity;
    const here = game.roomMap[game.position[0]][game.position[1]];
    log("You move to " + here);
    if (here === game.ghostRoom) log(ghostProfiles[game.ghost].behavior);
  } else if (c === "inventory") {
    log("Inventory: " + game.inventory.join(", "));
  } else if (c === "van") {
    openVanPanel();
  } else if (c === "end") {
    endGame(game.ghost !== null);
  } else {
    log("Unknown command.");
  }
}
</script>
<script>
function renderEvidence() {
  const container = document.getElementById("evidence-checklist");
  container.innerHTML = "";
  evidenceTypes.forEach(ev => {
    let label = document.createElement("label");
    let checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = selectedEvidence.has(ev);
    checkbox.onchange = () => {
      if (checkbox.checked) selectedEvidence.add(ev);
      else selectedEvidence.delete(ev);
      renderEvidence();
    };
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(ev));
    container.appendChild(label);
  });

  const match = Object.entries(evidenceMap).filter(([ghost, evs]) =>
    [...selectedEvidence].every(ev => evs.includes(ev))
  ).map(([ghost]) => ghost);

  document.getElementById("remaining-ghosts").textContent =
    match.length ? "Possible: " + match.map(g => g.toUpperCase()).join(", ") : "No matches.";
}

function useItem(item) {
  if (!item || !game.ghost || !ghostProfiles[game.ghost]) {
    log("Nothing happens.");
    return;
  }

  log("Used: " + item);
  const ghost = ghostProfiles[game.ghost];
  const room = game.roomMap[game.position[0]][game.position[1]];
  const inRoom = room === game.ghostRoom;

  switch (item.toLowerCase()) {
    case "emf":
      if (ghost.tools.includes("emf") && inRoom) {
        log("EMF spikes to 5!"); checkEvidence("EMF Level 5");
      } else log("No EMF detected.");
      break;
    case "spirit box":
      if (ghost.tools.includes("spirit box") && inRoom) {
        log("Spirit Box crackles!"); checkEvidence("Spirit Box");
      } else log("Only static.");
      break;
    case "uv":
    case "fingerprints":
      if (ghost.tools.includes("uv") && inRoom) {
        log("Fingerprints appear!"); checkEvidence("Fingerprints");
      } else log("No prints found.");
      break;
    case "book":
    case "notebook":
      if (ghost.tools.includes("book") && inRoom) {
        log("Ghost writing appears!"); checkEvidence("Ghost Writing");
      } else openJournal();
      break;
    case "thermometer":
      if (ghost.tools.includes("thermometer") && inRoom) {
        log("Freezing temps detected!"); checkEvidence("Freezing Temps");
      } else log("Normal temperature.");
      break;
    case "dots":
      if (ghost.tools.includes("dots") && inRoom) {
        log("Motion on the DOTS projector!"); checkEvidence("D.O.T.S");
      } else log("No motion detected.");
      break;
    case "camera":
      if (ghost.tools.includes("camera") && inRoom) {
        log("Ghost orbs captured!"); checkEvidence("Orbs");
      } else log("Nothing appears.");
      break;
    case "salt":
      log(ghost.intro); break;
    case "smudge":
      if (game.vanStock["Smudge"]) {
        game.vanStock["Smudge"]--; log("Smudge burned. You feel safer.");
      } else log("You're out of smudge sticks.");
      break;
    case "crucifix":
      log("You place a crucifix."); break;
    case "candle":
      log("The candle flickers."); break;
    default:
      log("The item has no effect.");
  }
}

function checkEvidence(ev) {
  selectedEvidence.add(ev);
  renderEvidence();
}

function openGuess() {
  const pop = document.getElementById("guess-popup");
  const lst = document.getElementById("guess-list");
  lst.innerHTML = "";

  Object.keys(ghostProfiles).forEach(key => {
    const btn = document.createElement("button");
    btn.textContent = key.toUpperCase();
    btn.dataset.ghostKey = key;
    btn.onclick = (e) => {
      const guessed = e.target.dataset.ghostKey;
      makeGuess(guessed);
      closeGuess();
    };
    lst.appendChild(btn);
  });

  pop.style.display = "block";
}

function makeGuess(g) {
  if (g.toLowerCase() === game.ghost.toLowerCase()) {
    log("✅ Correct! You solved it.");
    endGame(true);
  } else {
    log("❌ Incorrect. The ghost was " + game.ghost.toUpperCase());
    endGame(false);
  }
}

function endGame(won) {
  document.getElementById("ada-modal").style.display = "none";
  const msg = won ? "🎉 You Win!" : "💀 You Lose!";
  alert(msg + "\nGhost was: " + game.ghost.toUpperCase());
  const ui = document.getElementById("game-ui");
  const btn = document.createElement("button");
  btn.textContent = "🔄 Play Again";
  btn.onclick = () => location.reload();
  ui.innerHTML = ""; ui.appendChild(btn);
}

function openVanPanel() {
  const panel = document.getElementById("van-panel");
  const list = document.getElementById("van-button-list");
  list.innerHTML = "";

  Object.keys(game.vanStock).forEach(item => {
    if (game.vanStock[item] > 0) {
      const btn = document.createElement("button");
      btn.textContent = `Take ${item}`;
      btn.onclick = () => {
        if (game.inventory.length < 5) {
          game.inventory.push(item);
          game.vanStock[item]--;
          openVanPanel();
        }
      };
      list.appendChild(btn);
    }
  });

  list.appendChild(document.createElement("hr"));
  game.inventory.forEach((it, i) => {
    if (!["Notebook", "Lighter"].includes(it)) {
      const btn = document.createElement("button");
      btn.textContent = `Return ${it}`;
      btn.onclick = () => {
        game.inventory.splice(i, 1);
        game.vanStock[it] = (game.vanStock[it] || 0) + 1;
        openVanPanel();
      };
      list.appendChild(btn);
    }
  });

  panel.style.display = "block";
}

function closeVanPanel() {
  document.getElementById("van-panel").style.display = "none";
}

function openItemPopup() {
  const pop = document.getElementById("item-popup");
  const list = document.getElementById("item-button-list");
  list.innerHTML = "";
  game.inventory.forEach(item => {
    const b = document.createElement("button");
    b.textContent = item;
    b.onclick = () => {
      useItem(item);
      closeItemPopup();
    };
    list.appendChild(b);
  });
  pop.style.display = "block";
}
function closeItemPopup() {
  document.getElementById("item-popup").style.display = "none";
}

function loadJournal() {
  const val = localStorage.getItem("journal");
  if (val) document.getElementById("journal-text").value = val;
}
function saveJournal() {
  localStorage.setItem("journal", document.getElementById("journal-text").value);
}
function openJournal() {
  document.getElementById("journal-screen").style.display = "block";
}
function closeJournal() {
  saveJournal();
  document.getElementById("journal-screen").style.display = "none";
}
</script>
<script>
// === Orb Canvas Animation ===
const canvas = document.getElementById("orb-canvas");
const ctx = canvas.getContext("2d");
let width = canvas.width = window.innerWidth;
let height = canvas.height = window.innerHeight;

function createOrb() {
  return {
    x: Math.random() * width,
    y: Math.random() * height,
    vx: (Math.random() - 0.5) * 0.8,
    vy: (Math.random() - 0.5) * 0.8,
    baseRadius: Math.random() * 2 + 1,
    radius: 1,
    opacity: 0,
    fadeIn: true,
    tick: 0,
    changeInterval: Math.floor(Math.random() * 150 + 50)
  };
}

let orbs = [];
for (let i = 0; i < 15; i++) orbs.push(createOrb());

function animateOrbs() {
  ctx.clearRect(0, 0, width, height);
  for (let orb of orbs) {
    orb.tick++;
    orb.radius = orb.baseRadius + Math.sin(orb.tick / 30) * 0.5;

    if (orb.fadeIn) {
      orb.opacity += 0.01;
      if (orb.opacity >= 0.6) {
        orb.opacity = 0.6;
        orb.fadeIn = false;
      }
    } else {
      orb.opacity -= 0.001;
    }

    if (orb.opacity <= 0.01) {
      Object.assign(orb, createOrb());
      continue;
    }

    if (orb.tick % orb.changeInterval === 0) {
      const angle = Math.random() * 2 * Math.PI;
      const speed = Math.sqrt(orb.vx ** 2 + orb.vy ** 2);
      orb.vx = orb.vx * 0.8 + Math.cos(angle) * speed * 0.2;
      orb.vy = orb.vy * 0.8 + Math.sin(angle) * speed * 0.2;
    }

    orb.x += orb.vx;
    orb.y += orb.vy;

    if (orb.x - orb.radius <= 0 || orb.x + orb.radius >= width) orb.vx *= -1;
    if (orb.y - orb.radius <= 0 || orb.y + orb.radius >= height) orb.vy *= -1;

    ctx.beginPath();
    ctx.arc(orb.x, orb.y, orb.radius, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255,255,255,${orb.opacity})`;
    ctx.shadowColor = `rgba(255,255,255,${orb.opacity * 0.6})`;
    ctx.shadowBlur = 10 + orb.opacity * 10;
    ctx.fill();
  }

  requestAnimationFrame(animateOrbs);
}
animateOrbs();

window.addEventListener("resize", () => {
  width = canvas.width = window.innerWidth;
  height = canvas.height = window.innerHeight;
});
</script>

<!-- ⚡ Lightning Overlay -->
<div id="flash-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;
  background:white;opacity:0;pointer-events:none;z-index:999;"></div>
<script>
function lightningFlash() {
  const flash = document.getElementById("flash-overlay");
  if (!flash) return;
  flash.style.opacity = "0.4";
  setTimeout(() => { flash.style.opacity = "0"; }, 150);
}
setInterval(() => {
  if (Math.random() > 0.6) lightningFlash();
}, 7000);
</script>

<script>
// === Main Startup Hook ===
document.addEventListener("DOMContentLoaded", () => {
  showLoadoutScreen();
});
</script>

<style>
@media (max-width: 768px) {
  #game-ui {
    margin: 80px 10px 10px 10px;
  }
  #evidence-panel {
    top: auto;
    bottom: 80px;
    right: 10px;
    width: calc(100vw - 20px);
  }
  #status-bar {
    flex-direction: column;
    align-items: flex-start;
    font-size: 0.9em;
  }
  #status-bar > div {
    margin-bottom: 4px;
  }
  #ada-modal, #van-panel, #guess-popup, #journal-screen,
  #loadout-screen, #item-popup {
    width: 95%;
    max-width: 95%;
    height: auto;
    max-height: 90vh;
    overflow-y: auto;
  }
  .scene-container .layer {
    object-fit: contain;
  }
}
</style>

